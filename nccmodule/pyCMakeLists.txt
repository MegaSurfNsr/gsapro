cmake_minimum_required(VERSION 3.4)

set(CMAKE_CUDA_COMPILER "/usr/local/cuda-12.1/bin/nvcc")
set(CMAKE_CXX_STANDARD 14)

set(CMAKE_BUILD_TYPE "Release")
# set(CMAKE_CXX_STANDARD 17)
# set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++17")
set(CUDA_NVCC_FLAGS ${CUDA_NVCC_FLAGS};-O3 --use_fast_math --maxrregcount=128 --ptxas-options=-v -std=c++14 --compiler-options -Wall -gencode arch=compute_75,code=sm_75 -gencode arch=compute_75,code=sm_75)


project(bindings VERSION 0.1.1 LANGUAGES CXX CUDA)
add_subdirectory(extern/pybind11)
include_directories("extern/pybind11/include")

set(Torch_DIR /home/yswang/Downloads/software/libtorch-cxx11-abi-shared-with-deps-2.0.0+cu117/libtorch/share/cmake/Torch)

message("--++ "${CUDNN_LIBRARY_PATH})

find_package(Torch REQUIRED)
include_directories(${TORCH_INCLUDE_DIRS})
message("--++ TORCH_INCLUDE_DIRS "${TORCH_INCLUDE_DIRS})

find_library(TORCH_PYTHON_LIBRARY torch_python PATHS "${TORCH_INSTALL_PREFIX}/lib" REQUIRED)

find_package(Python3 COMPONENTS Interpreter Development REQUIRED)
include_directories(${Python3_INCLUDE_DIRS})
message("--++ Python_INCLUDE_DIRS "${Python3_INCLUDE_DIRS})

find_package(CUDA 11.0 REQUIRED) # For Cuda Managed Memory and c++11
find_package(OpenCV REQUIRED)
include_directories(${OpenCV_INCLUDE_DIRS})
include_directories(${CUDA_INCLUDE_DIRS})
message("--++ CUDA_INCLUDE_DIRS "${CUDA_INCLUDE_DIRS})

pybind11_add_module(
    ncc     
    main.h
    main.cpp

    ACMH.h
    ACMH.cpp
    ACMH.cu

    nccmodule.h
    nccmodule.cu
    nccmodule.cpp)

set_property(TARGET ncc PROPERTY CUDA_ARCHITECTURES 75)

target_link_libraries(ncc PUBLIC ${TORCH_LIBRARIES})
target_link_libraries(ncc PUBLIC ${TORCH_PYTHON_LIBRARY})
target_link_libraries(ncc PUBLIC ${Python3_LIBRARIES})
target_link_libraries(ncc PUBLIC ${OpenCV_LIBS})

message("--++ Python3_LIBRARIES  "${Python3_LIBRARIES})
message("--++ torch libraries  "${TORCH_LIBRARIES})
message("--++ torch python library " ${TORCH_PYTHON_LIBRARY})

